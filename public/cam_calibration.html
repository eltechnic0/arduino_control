<!DOCTYPE html>
<html>
  <head>
    <title>Camera Calibration</title>
    <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <script>
      $(document).ready(function() {
        var rect = {topleft: {x:0, y:0}, bottomright: {x:50, y:50}};

        var redrawrect = function() {
          $("#rectangle").css({
            left: rect["topleft"].x,
            top: rect["topleft"].y,
            width: -rect["topleft"].x + rect["bottomright"].x,
            height: -rect["topleft"].y + rect["bottomright"].y
          });
        };

        var resetrect = function() {
          var offset = $("#cam-image").offset();
          rect = {
            topleft: {
              x: offset.left,
              y: offset.top
            },
            bottomright: {
              x: $("#cam-image").width() + offset.left,
              y: $("#cam-image").height() + offset.top
            }
          };
          redrawrect();
        }

        $("cam-image").ready(function(){
          resetrect();
        });

        $("button[name=refresh]").click(function() {
          $.get("/calibration/refresh").done(function() {
            var name = "static/outfile.jpeg?" + Date.now();
            $("#cam-image").attr("src", name);
            resetrect();
          });
        });

        $("button[name=save]").click(function() {
          // save bounding box coords in pixels, with respect to the image, and
          // with (0,0) being the top left corner
          var ofsim = $("#cam-image").offset();
          data = {}
          data.topleft = {
              x: rect.topleft.x - ofsim.left,
              y: rect.topleft.y - ofsim.top,
          };
          data.bottomright = {
              x: rect.bottomright.x - ofsim.left,
              y: rect.bottomright.y - ofsim.top
          };
          $.ajax({
            url:"/calibration/save",
            method:'POST',
            data:JSON.stringify(data),
            contentType: 'application/json'
          })
          .done(function(result) {
            if(result == true) {
              window.app.flashMessage('Bounding box saved', 'success');
            } else {
              window.app.flashMessage('Error saving', 'error');
            }
          });
        });

        $("button[name=reset]").click(function() {
          resetrect();
        });

        $("#cam-image").click(function(e) {
          var distfunc = function(v1, v2) {
            return Math.sqrt((v2.x-v1.x)*(v2.x-v1.x) + (v2.y-v1.y)*(v2.y-v1.y));
          };
          var x = e.pageX;
          var y = e.pageY;
          var newpos = {x:x, y:y};

          var dist0 = distfunc(newpos, rect["topleft"]);
          var dist1 = distfunc(newpos, rect["bottomright"]);

          if(dist0 < dist1) {
            rect["topleft"] = newpos;
          } else {
            rect["bottomright"] = newpos;
          }
          redrawrect();
        });
      });
    </script>
    <style>
      #rectangle {
        position: fixed;
        left: 0px;
        top: 0px;
        width: 200px;
        height: 100px;
        border: 1px solid rgb(55, 255, 0);
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <h1>Camera input</h1>
      <div id="rectangle"></div>
      <img id="cam-image" src="static/outfile.jpeg" alt="Camera image">
      <!-- <img id="cam-image" src="../webcam/outfile.jpeg" alt="Camera image"> -->
      <br>
      <button name="refresh">Refresh</button>
      <button name="save">Save</button>
      <!-- <button name="load">Load</button> -->
      <button name="reset">Reset</button>
    </div>
  </body>
</html>
